//rule no_sqli.js
module.exports = async function detectAndCheckSQLInjection(text) {
    const lines = text.split('\n');

    const vulnerabilities = [];

    let inMultiLineComment = false;

    for (let lineNumber = 0; lineNumber < lines.length; lineNumber++) {
        const line = lines[lineNumber].trim();

        // Check for multi-line comment start and end
        if (line.includes('/*')) inMultiLineComment = true;
        if (line.includes('*/')) inMultiLineComment = false;
        if (inMultiLineComment || line.startsWith('//') || line.startsWith('#')) continue;

        const response = await checkSQLInjection(line);
        if (response) {
            vulnerabilities.push({
                type: response.type,
                recommendation: response.recommendation,
                vulnerableCode:line,
                lineNumber: lineNumber + 1
            });
        }
    }

    return vulnerabilities;
}

async function checkSQLInjection(query) {
    
    const sqliPatterns = [
        {
            pattern: /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?(?:\bOR\b|\bAND\b)\s*('[^']*'|[0-9]+)\s*;?)(?!\s*['":])(?!\s*'\w+')/i,
            type: "Basic Injection",
            recommendation: "Use parameterized queries to prevent this type of injection."
        },
        {
            pattern: /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\bUNION\b\s+SELECT\b)/i,
            type: "Union Based Injection",
            recommendation: "Ensure all user inputs are sanitized, particularly in complex queries involving UNION."
        },
        {
            pattern: /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b[0-9]+\b(?:\s*OR\b\s*1=1)?)/i,
            type: "Tautology Based Injection",
            recommendation: "Use parameterized queries or prepared statements to avoid direct inclusion of user input."
        },
        {
            pattern: /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\bIF\b\s*\([^)]*\)\s*\bSLEEP\b\s*\([^)]*\))/i,
            type: "Time-Based Injection",
            recommendation: "Use parameterized queries and implement CAPTCHA to deter automated time-based attacks."
        },
        {
            pattern: /(\bINSERT\s+INTO\s+\w+\s*\([^)]*\)\s*VALUES\s*\(\s*'[^']*'\s*,\s*'[^']*'\s*\)\s*;?)/i,
            type: "Direct Insert Injection",
            recommendation: "Avoid constructing SQL queries directly from user inputs; use parameterized statements."
        },
        {
            pattern: /(\bINSERT\s+INTO\s+\w+\s*\([^)]*\)\s*VALUES\s*\(\s*\$\{[^}]*\}\s*,\s*\$\{[^}]*\}\s*\)\s*;?)/i,
            type: "Template Literal Injection",
            recommendation: "Validate and sanitize template literals, using context-specific validation."
        },
        {
            pattern: /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b\s*'\$\w+'\s*;?)/i,
            type: "String Concatenation Injection",
            recommendation: "Never concatenate user-controlled variables directly into SQL queries."
        },
        {
            pattern: /(\bWAITFOR\s+DELAY\s+'\d{2}:\d{2}:\d{2}'\s*;?)/i,
            type: "Delay-Based Injection",
            recommendation: "Limit database user permissions and use parameterized queries to prevent execution delays."
        },
        {
            pattern: /(\bUNION\s+SELECT\b)/i,
            type: "Union Query Injection",
            recommendation: "Use rigorous input validation and parameterized queries to prevent this type of attack."
        },
        {
            pattern: /(\bDROP\s+TABLE\b)/i,
            type: "Destructive Query Injection",
            recommendation: "Restrict database permissions and ensure user inputs cannot alter database structure."
        },
        {
            pattern: /(\bAND\s+\$\{\w+\})/i,
            type: "Logical Operator Injection",
            recommendation: "Implement strict input validation to prevent the manipulation of logical operators."
        },
        {
            pattern: /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\s*\${[^};]*};?)/i,
            type: "Template Injection",
            recommendation: "Avoid using template strings to construct SQL queries. Prefer parameterized queries."
        },

    ];
    
    // Check if the query matches any vulnerable pattern
    for (const { pattern, type, recommendation } of sqliPatterns) {
        if (pattern.test(query)) {
            return { type, recommendation, vulnerableCode: query };
        }
    }

    return 0;
}


        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\bUNION\b\s+SELECT\b)/i,
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b[0-9]+\b(?:\s*OR\b\s*1=1)?)/i,
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\bIF\b\s*\([^)]*\)\s*\bSLEEP\b\s*\([^)]*\))/i,
        // /(\bINSERT\s+INTO\s+\w+\s*\([^)]*\)\s*VALUES\s*\(\s*'[^']*'\s*,\s*'[^']*'\s*\)\s*;?)/i,
        // /(\bINSERT\s+INTO\s+\w+\s*\([^)]*\)\s*VALUES\s*\(\s*\$\{[^}]*\}\s*,\s*\$\{[^}]*\}\s*\)\s*;?)/i,
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b\s*('\$\w+'\s*|[^'";\n]+)\s*;?)/i,
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b\s*`[^`]*`\s*;?)/i,
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b\s*"([^"]|\\")*"\s*;?)/i,
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b\s*`[^`]*`\s*;?)/i,
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b\s*\${[^}]*}\s*;?)/i,
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b\s*`?[^`]*`?\s*;?)/i, 
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b\s*'.*'\s*;?)/i, 
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\b\s*\$\{[^}]*\}\s*;?)/i, 
        // /(\bBETWEEN\s+\$\{\w+\})/i, 
        // /(\bAND\s+\$\{\w+\})/i,
        // /(\bSELECT\s+.*?\bFROM\b\s+.*?\bWHERE\b\s+.*?\b=\s*\${[^};]*};?)/i,
        // /(\bWAITFOR\s+DELAY\s+'\d{2}:\d{2}:\d{2}'\s*;?)/i,
        // /(\bIF\s*\([^)]*\)\s*WAITFOR\s+DELAY\s+'\d{2}:\d{2}:\d{2}'\s*;?)/i,
        // /(\bSLEEP\s*\(\s*\d+\s*\)\s*;?)/i,
        // /(\bBENCHMARK\s*\(\s*\d+\s*,\s*MD5\('A'\)\s*\)\s*;?)/i,
        // /(\bAND\s+1=(?:0|1)\s*;?)/i,
        // /(\bOR\s+1=(?:0|1)\s*;?)/i,
        // /(\bUNION\s+SELECT\b)/i,
        // /(\bDROP\s+TABLE\b)/i,
        // /(\bWAITFOR\s+DELAY\s+'\d{2}:\d{2}:\d{2}'\s*;?)/i,
        // /(\bAND\s+\d+=\d+\s*--\s*\d+)/i,